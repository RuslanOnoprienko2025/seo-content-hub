---
import { getCollection } from 'astro:content';
import Layout from '../layouts/Layout.astro';

// 1. Получаем домен (чистый и стабильный вариант)
const forwardedHost = Astro.request.headers.get('x-forwarded-host');
const hostHeader = Astro.request.headers.get('host');
const cfIp = Astro.request.headers.get('cf-connecting-ip');

let rawHostname;
if (cfIp) {
    rawHostname = forwardedHost || hostHeader;
} else {
    rawHostname = Astro.url.hostname;
}

// Убираем порт и лишние пробелы, чтобы не было ошибки 500
const hostname = rawHostname ? rawHostname.split(':')[0].trim() : '';

// 2. Полная карта SEO и проектов (7 доменов)
const seoConfigs = {
  "blog.fastimageconvert.onl": {
    title: "JPG to WebP Conversion Guide - Optimization Tips",
    description: "Learn how to convert JPG to WebP for better performance. Expert guides on compression techniques, quality settings, and modern format benefits.",
    canonical: "https://blog.fastimageconvert.onl/",
    project: "jpg-to-webp"
  },
  "blog.fastimageconvert.online": {
    title: "WebP Optimization Guide - PNG Compression Tips",
    description: "Master WebP format for modern websites. Learn compression techniques, transparency handling, and performance optimization for PNG images.",
    canonical: "https://blog.fastimageconvert.online/",
    project: "png-to-webp"
  },
  "blog.fastimageconvert.xyz": {
    title: "WebP to PNG Guide - Compatibility & Design Tips",
    description: "Convert WebP to PNG while preserving quality. Expert guides on compatibility, transparency, and professional design workflows.",
    canonical: "https://blog.fastimageconvert.xyz/",
    project: "webp-to-png"
  },
  "blog.fastimageconvert.pro": {
    title: "WebP to JPG Conversion Guide - Compatibility Tips",
    description: "Learn how to convert WebP to JPG for universal compatibility. Expert guides on quality settings, compression techniques, and device support.",
    canonical: "https://blog.fastimageconvert.pro/",
    project: "webp-to-jpg"
  },
  "blog.fastimageconvert.pics": {
    title: "PNG to JPG Guide - Compression & Quality Tips",
    description: "Learn how to compress PNG to JPG efficiently. Expert guides on quality settings, file size reduction, and choosing the right format for web use.",
    canonical: "https://blog.fastimageconvert.pics/",
    project: "png-to-jpg"
  },
  "blog.fastimageconvert.help": {
    title: "PNG Transparency Guide - JPG Conversion Tips",
    description: "Learn how to add transparency to images by converting JPG to PNG. Expert guides on alpha channels, logo creation, and lossless quality.",
    canonical: "https://blog.fastimageconvert.help/",
    project: "jpg-to-png"
  },
  "blog.emailsignatures.xyz": {
    title: "Email Signature Best Practices - Business Tips",
    description: "Learn email signature best practices for business. Expert guides on formatting, contact details, branding, and professional communication standards.",
    canonical: "https://blog.emailsignatures.xyz/",
    project: "signatures"
  }
};

// 3. Прямое сравнение БЕЗ очистки
let currentConfig = seoConfigs[hostname];

// Если не нашли - попробуем убрать www
if (!currentConfig) {
  const withoutWww = hostname.replace('www.', '');
  currentConfig = seoConfigs[withoutWww];
}

// Если всё ещё не нашли - дефолтный конфиг
if (!currentConfig) {
  console.error("DEBUG: Hostname not matched. Received:", hostname);
  currentConfig = seoConfigs["blog.fastimageconvert.help"]; // Дефолтный
}

// 4. Получаем все статьи из папки src/content/blog/ (как в твоем исходном коде)
const allPosts = await getCollection('blog');

// 5. Фильтруем статьи по метке project, которую мы указали в seoConfigs
const filteredPosts = allPosts.filter(post => post.data.project === currentConfig.project);

// 6. Сортируем статьи по дате (свежие сверху)
const sortedPosts = filteredPosts.sort((a, b) => 
  new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);
---

<Layout title={currentConfig.title} description={currentConfig.description} canonical={currentConfig.canonical} project={currentConfig.project} image="">
  <header style="margin-bottom: 40px; border-bottom: 1px solid #eee; padding-bottom: 20px;">
    <h1>{currentConfig.title}</h1>
  </header>

  <style>
  .posts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 2rem;
    padding: 2rem 0;
  }
  .post-card {
    border: 1px solid #eee;
    padding: 1.5rem;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    background: #fff;
  }
  .post-card h2 {
    font-size: 1.3rem !important;
    margin-bottom: 0.5rem;
  }
  .post-card p {
    font-size: 0.95rem;
    color: #555;
    flex-grow: 1;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

<section class="posts-grid">
  {sortedPosts.length > 0 ? (
    sortedPosts.map(post => (
      <article class="post-card">
        <h2>
          <a href={`/${post.slug}/`} style="color: #1a1a1a; text-decoration: none;">
            {post.data.title}
          </a>
        </h2>
        <p>{post.data.description}</p>
        <a href={`/${post.slug}/`} style="color: #0070f3; font-weight: bold; text-decoration: none; margin-top: 1rem; font-size: 0.9rem;">
          Read article →
        </a>
      </article>
    ))
  ) : (
    <p>Articles for this project are coming soon.</p>
  )}
</section>
</Layout>

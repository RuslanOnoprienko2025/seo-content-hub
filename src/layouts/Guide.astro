---
import { Image } from 'astro:assets';
import Layout from './Layout.astro';
const { title, seo_title, description, image, show_image, project } = Astro.props;
const content = { title, seo_title, description, image, show_image, project };

// Динамический импорт изображения из src/assets/images
let resolvedImage = null;
let optimizedImage = null;

if (content.image) {
  const images = import.meta.glob<{ default: ImageMetadata }>('/src/assets/images/**/*.{jpeg,jpg,png,gif,webp,JPG,PNG,WEBP}', { eager: true });
  const imagePath = content.image.startsWith('/') ? content.image : `/src/assets/images/${content.image}`;
  
  // Проверяем разные варианты пути
  const possiblePaths = [
    imagePath,
    `/src/assets/${content.image}`,
    content.image
  ];
  
  for (const path of possiblePaths) {
    if (images[path]) {
      resolvedImage = images[path].default;
      break;
    }
  }
// 2. Генерируем WebP версию "на лету"
  if (resolvedImage) {
    optimizedImage = await getImage({ 
      src: resolvedImage, 
      format: 'webp', 
      quality: 80 
    });
  }
}
---
<Layout title={content.seo_title || content.title} description={content.description} image={content.image} project={content.project}>
    <article>
        <div style="text-transform: uppercase; letter-spacing: 0.1em; font-size: 0.75rem; font-weight: 700; color: var(--accent); margin-bottom: 1rem;">
            Step-by-Step Guide
        </div>
        <h1>{content.title}</h1>

{/* 3. Выводим уже оптимизированный объект */}
        {optimizedImage && content.show_image && (
          <img 
            src={optimizedImage.src} 
            alt={content.seo_title || content.title}
            {...optimizedImage.attributes}
            loading="eager"
            style="width: 100%; height: auto; border-radius: 12px; margin: 2rem 0; display: block;"
          />
        )}

        <section class="guide-content">
            <slot /> 
        </section>
    </article>
</Layout>
